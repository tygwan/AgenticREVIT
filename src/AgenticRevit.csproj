<?xml version="1.0" encoding="utf-8"?>
<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFramework>net48</TargetFramework>
    <LangVersion>latest</LangVersion>
    <RootNamespace>AgenticRevit</RootNamespace>
    <AssemblyName>AgenticRevit</AssemblyName>
    <GenerateAssemblyInfo>false</GenerateAssemblyInfo>
    <UseWPF>true</UseWPF>
    <UseWindowsForms>true</UseWindowsForms>
    <OutputType>Library</OutputType>
    <AppendTargetFrameworkToOutputPath>false</AppendTargetFrameworkToOutputPath>
    <AppendRuntimeIdentifierToOutputPath>false</AppendRuntimeIdentifierToOutputPath>
    <Platforms>x64</Platforms>
    <PlatformTarget>x64</PlatformTarget>
    <Nullable>enable</Nullable>
  </PropertyGroup>

  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <OutputPath>bin\Debug\</OutputPath>
    <DebugType>full</DebugType>
    <DebugSymbols>true</DebugSymbols>
    <DefineConstants>DEBUG;TRACE</DefineConstants>
  </PropertyGroup>

  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <OutputPath>bin\Release\</OutputPath>
    <DebugType>pdbonly</DebugType>
    <Optimize>true</Optimize>
    <DefineConstants>TRACE</DefineConstants>
  </PropertyGroup>

  <!-- Revit 2025 API References -->
  <ItemGroup>
    <!-- Update these paths to your Revit 2025 installation -->
    <Reference Include="RevitAPI">
      <HintPath>C:\Program Files\Autodesk\Revit 2025\RevitAPI.dll</HintPath>
      <Private>False</Private>
    </Reference>
    <Reference Include="RevitAPIUI">
      <HintPath>C:\Program Files\Autodesk\Revit 2025\RevitAPIUI.dll</HintPath>
      <Private>False</Private>
    </Reference>
    <Reference Include="AdWindows">
      <HintPath>C:\Program Files\Autodesk\Revit 2025\AdWindows.dll</HintPath>
      <Private>False</Private>
    </Reference>
    <Reference Include="UIFramework">
      <HintPath>C:\Program Files\Autodesk\Revit 2025\UIFramework.dll</HintPath>
      <Private>False</Private>
    </Reference>
  </ItemGroup>

  <!-- NuGet Packages -->
  <ItemGroup>
    <PackageReference Include="Newtonsoft.Json" Version="13.0.3" />
    <PackageReference Include="Serilog" Version="3.1.1" />
    <PackageReference Include="Serilog.Sinks.File" Version="5.0.0" />
    <PackageReference Include="Neo4j.Driver" Version="5.15.0" />
  </ItemGroup>

  <!-- System References -->
  <ItemGroup>
    <Reference Include="System.Net.Http" />
    <Reference Include="WindowsBase" />
    <Reference Include="PresentationCore" />
    <Reference Include="PresentationFramework" />
  </ItemGroup>

  <!-- Post-Build Event: Deploy to Revit Addins folder -->
  <PropertyGroup>
    <RevitAddinsPath>$(APPDATA)\Autodesk\Revit\Addins\2025</RevitAddinsPath>
    <DeploymentLogPath>$(ProjectDir)..\logs</DeploymentLogPath>
  </PropertyGroup>

  <!-- Check if Revit is running before deployment -->
  <Target Name="CheckRevitProcess" BeforeTargets="DeployToRevit">
    <Exec Command="tasklist /FI &quot;IMAGENAME eq Revit.exe&quot; 2>NUL | find /I /N &quot;Revit.exe&quot; >NUL"
          IgnoreExitCode="true">
      <Output TaskParameter="ExitCode" PropertyName="RevitRunning"/>
    </Exec>
    <Warning Text="âš ï¸ WARNING: Revit is currently running. File locks may prevent deployment. Consider closing Revit."
             Condition="'$(RevitRunning)'=='0'" />
  </Target>

  <!-- Main deployment target -->
  <Target Name="DeployToRevit" AfterTargets="Build">
    <Message Text="â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" Importance="high" />
    <Message Text="  AgenticREVIT Deployment - $(Configuration) Build" Importance="high" />
    <Message Text="â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" Importance="high" />

    <!-- Create directories -->
    <MakeDir Directories="$(RevitAddinsPath)" Condition="!Exists('$(RevitAddinsPath)')" />
    <MakeDir Directories="$(DeploymentLogPath)" Condition="!Exists('$(DeploymentLogPath)')" />

    <!-- Clean old deployment for Release builds -->
    <ItemGroup Condition="'$(Configuration)'=='Release'">
      <OldDeployedFiles Include="$(RevitAddinsPath)\AgenticRevit.*" />
      <OldDeployedFiles Include="$(RevitAddinsPath)\Neo4j.Driver*.dll" />
      <OldDeployedFiles Include="$(RevitAddinsPath)\Serilog*.dll" />
    </ItemGroup>
    <Delete Files="@(OldDeployedFiles)" Condition="'$(Configuration)'=='Release'" ContinueOnError="true" />
    <Message Text="âœ“ Cleaned old deployment files (Release mode)" Importance="high" Condition="'$(Configuration)'=='Release'" />

    <!-- Copy main assembly -->
    <Message Text="â–º Deploying AgenticRevit.dll..." Importance="high" />
    <Copy SourceFiles="$(OutputPath)AgenticRevit.dll"
          DestinationFolder="$(RevitAddinsPath)"
          SkipUnchangedFiles="true"
          Retries="3"
          RetryDelayMilliseconds="1000" />

    <!-- Copy PDB for Debug builds -->
    <Copy SourceFiles="$(OutputPath)AgenticRevit.pdb"
          DestinationFolder="$(RevitAddinsPath)"
          SkipUnchangedFiles="true"
          Condition="'$(Configuration)'=='Debug' AND Exists('$(OutputPath)AgenticRevit.pdb')" />

    <!-- Copy all NuGet dependency DLLs using wildcard pattern -->
    <Message Text="â–º Deploying NuGet dependencies..." Importance="high" />
    <ItemGroup>
      <NuGetDependencies Include="$(OutputPath)Neo4j.Driver*.dll" />
      <NuGetDependencies Include="$(OutputPath)Newtonsoft.Json.dll" />
      <NuGetDependencies Include="$(OutputPath)Serilog*.dll" />
    </ItemGroup>
    <Copy SourceFiles="@(NuGetDependencies)"
          DestinationFolder="$(RevitAddinsPath)"
          SkipUnchangedFiles="true"
          Retries="3"
          RetryDelayMilliseconds="1000" />

    <!-- Copy System dependencies with existence check -->
    <Message Text="â–º Deploying System dependencies..." Importance="high" />
    <ItemGroup>
      <SystemDependencies Include="$(OutputPath)Microsoft.Bcl.AsyncInterfaces.dll" Condition="Exists('$(OutputPath)Microsoft.Bcl.AsyncInterfaces.dll')" />
      <SystemDependencies Include="$(OutputPath)System.Buffers.dll" Condition="Exists('$(OutputPath)System.Buffers.dll')" />
      <SystemDependencies Include="$(OutputPath)System.Memory.dll" Condition="Exists('$(OutputPath)System.Memory.dll')" />
      <SystemDependencies Include="$(OutputPath)System.Runtime.CompilerServices.Unsafe.dll" Condition="Exists('$(OutputPath)System.Runtime.CompilerServices.Unsafe.dll')" />
      <SystemDependencies Include="$(OutputPath)System.Threading.Tasks.Extensions.dll" Condition="Exists('$(OutputPath)System.Threading.Tasks.Extensions.dll')" />
      <SystemDependencies Include="$(OutputPath)System.ValueTuple.dll" Condition="Exists('$(OutputPath)System.ValueTuple.dll')" />
      <SystemDependencies Include="$(OutputPath)System.Numerics.Vectors.dll" Condition="Exists('$(OutputPath)System.Numerics.Vectors.dll')" />
      <SystemDependencies Include="$(OutputPath)System.Diagnostics.DiagnosticSource.dll" Condition="Exists('$(OutputPath)System.Diagnostics.DiagnosticSource.dll')" />
      <SystemDependencies Include="$(OutputPath)System.Text.Encodings.Web.dll" Condition="Exists('$(OutputPath)System.Text.Encodings.Web.dll')" />
      <SystemDependencies Include="$(OutputPath)System.Text.Json.dll" Condition="Exists('$(OutputPath)System.Text.Json.dll')" />
    </ItemGroup>
    <Copy SourceFiles="@(SystemDependencies)"
          DestinationFolder="$(RevitAddinsPath)"
          SkipUnchangedFiles="true"
          ContinueOnError="true" />

    <!-- Copy .addin manifest file -->
    <Message Text="â–º Deploying AgenticRevit.addin manifest..." Importance="high" />
    <Copy SourceFiles="$(ProjectDir)..\AgenticRevit.addin"
          DestinationFolder="$(RevitAddinsPath)"
          SkipUnchangedFiles="true" />

    <!-- Write deployment log -->
    <PropertyGroup>
      <DeploymentTimestamp>$([System.DateTime]::Now.ToString("yyyy-MM-dd HH:mm:ss"))</DeploymentTimestamp>
    </PropertyGroup>
    <WriteLinesToFile File="$(DeploymentLogPath)\deployment.log"
                      Lines="[$(DeploymentTimestamp)] $(Configuration) build deployed to $(RevitAddinsPath)"
                      Overwrite="false" />

    <!-- Summary -->
    <Message Text="â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" Importance="high" />
    <Message Text="  âœ… DEPLOYMENT COMPLETE" Importance="high" />
    <Message Text="  ðŸ“ Location: $(RevitAddinsPath)" Importance="high" />
    <Message Text="  ðŸ“‹ Log: $(DeploymentLogPath)\deployment.log" Importance="high" />
    <Message Text="â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" Importance="high" />
  </Target>

  <!-- Verify deployment after copy -->
  <Target Name="VerifyDeployment" AfterTargets="DeployToRevit">
    <Error Text="âŒ Deployment failed: AgenticRevit.dll not found in $(RevitAddinsPath)"
           Condition="!Exists('$(RevitAddinsPath)\AgenticRevit.dll')" />
    <Error Text="âŒ Deployment failed: AgenticRevit.addin not found in $(RevitAddinsPath)"
           Condition="!Exists('$(RevitAddinsPath)\AgenticRevit.addin')" />
    <Message Text="  âœ“ Deployment verification passed" Importance="high" />
  </Target>

</Project>
